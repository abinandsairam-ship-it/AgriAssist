/**
 * @fileoverview Firestore Security Rules for Agriassist.
 *
 * Core Philosophy:
 * This ruleset enforces a flexible data model, allowing both authenticated and anonymous users
 * to submit entries while controlling who can modify or delete existing entries.
 *
 * Data Structure:
 * All entries are stored in the `/crop_data/{entryId}` collection. Each entry includes the submitter's `userId`
 * (which can be an empty string for anonymous users), a timestamp, crop details, and an image URL.
 *
 * Key Security Decisions:
 * - Entries are publicly readable.
 * - Only the owner (the user who created the entry) or an admin can update or delete an entry.
 * - `list` operations are allowed.
 * - The rules do not enforce a strict data schema to allow rapid iteration.
 *
 * Denormalization for Authorization:
 * To avoid costly `get()` calls, the `userId` is stored directly on each `/crop_data/{entryId}` document.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to the /crop_data/{entryId} collection.
     * @path /crop_data/{entryId}
     * @allow (get, list): Any user can read the entry.
     * @allow (create): Any user can create an entry. The userId must match the authenticated user's ID (or be an empty string for anonymous users).
     * @allow (update, delete): Only the owner (the user whose userId matches the entry's userId) can modify or delete the entry.
     * @deny (update, delete): Non-owners cannot modify or delete the entry.
     * @principle Public Read with Owner-Only Writes: Allows public read access while restricting write access to the entry's owner.
     */
    match /crop_data/{entryId} {
      // Allow anyone to read entries
      allow get, list: if true;

      // Allow create if the userId matches the authenticated user's ID or is an empty string (for anonymous users)
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid ||
                         request.resource.data.userId == "";

      // Allow update and delete only if the user is the owner of the entry and it exists
      allow update, delete: if isExistingOwner(resource.data.userId);

    }

    // --- Helper functions ---

    // Checks if the user is signed in.
    function isSignedIn() {
      return request.auth != null;
    }

    // Checks if the user is the owner of the resource.
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Checks if the user is the owner of the resource and the resource exists.
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
  }
}