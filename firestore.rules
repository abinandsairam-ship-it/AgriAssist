/**
 * @fileoverview Firestore Security Rules for Agriassist.
 *
 * Core Philosophy:
 * This ruleset enforces a mixed security model.  Unauthenticated users can create entries, but authenticated users' ownership will be validated if they provide a userId.
 *
 * Data Structure:
 * All entries are stored in the top-level `/crop_data/{entryId}` collection. Each entry document contains data about the crop and prediction results,
 * along with the user ID (if available).
 *
 * Key Security Decisions:
 * - Allows public read access to all entries.
 * - Allows unauthenticated creates, but authenticated user ID must match if provided.
 * - Enforces ownership for authenticated updates and deletes (if userId is populated).
 *
 * Denormalization for Authorization:
 *  - The `entryId` is denormalized and duplicated as the document ID to simplify `update` and `delete` rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to individual crop data entries.
     * @path /crop_data/{entryId}
     * @allow (get, list): Allow public access to read crop data entries.
     * @allow (create): Allow creation if userId matches auth.uid or userId is an empty string.
     * @allow (update, delete): Allow if the user is the owner of the entry and the entry exists.
     * @deny (create): Deny if userId doesn't match auth.uid when the user is authenticated.
     * @deny (update, delete): Deny if the user is not the owner of the entry or the entry does not exist.
     * @principle Allows public reads, but enforces ownership for updates and deletes.
     */
    match /crop_data/{entryId} {
      // Allow anyone to read the entries.
      allow get, list: if true;

      // Allow create if the user is not signed in or if the userId matches the authenticated user's ID.
      allow create: if isSignedIn() ? (request.resource.data.userId == request.auth.uid && request.resource.data.id == entryId) || (request.resource.data.userId == "") : request.resource.data.userId == "" && request.resource.data.id == entryId;

      // Only the owner can update or delete the entry, and the entry must exist.
      allow update, delete: if isExistingOwner(resource.data.userId);

    }
    // --- Helper Functions ---

    // Checks if the user is signed in.
    function isSignedIn() {
      return request.auth != null;
    }

    // Checks if the user is the owner of the resource.
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Checks if the user is the existing owner of the resource and the resource exists.
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
  }
}