/**
 * @fileOverview Firestore Security Rules for Agriassist.
 *
 * Core Philosophy:
 * This ruleset prioritizes user data privacy. Authenticated users have full access only to their own data.
 * Unauthenticated users may only read data.
 *
 * Data Structure:
 * The primary data is stored in the `/crop_data/{entryId}` collection.  Each document represents a user's form entry.
 * Each document includes the user's ID (`userId`), timestamp, crop details, image URL, and AI prediction results.
 *
 * Key Security Decisions:
 * - Public read access is granted to the `/crop_data` collection.
 * - Writes to the `/crop_data` collection are restricted to authenticated users only.
 * - Schema validation is relaxed in this prototyping phase, focusing on authorization.
 *
 * Denormalization for Authorization:
 * - The `userId` field within each `/crop_data/{entryId}` document is used to quickly determine ownership, avoiding the need for separate lookups.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants public read access and restricts writes to authenticated users for the /crop_data collection.
     * @path /databases/{database}/documents/crop_data/{entryId}
     * @allow (get, list): Any user can read the data.
     * @allow (create): Authenticated users can create new entries with a matching userId.
     * @allow (update, delete): Authenticated users can update or delete their own entries.
     * @deny (create): Unauthenticated users cannot create new entries.
     * @deny (update, delete): Authenticated users cannot modify or delete entries they don't own or that don't exist.
     * @principle Allows public read access while enforcing ownership for writes.
     */
    match /crop_data/{entryId} {
      allow get: if true;
      allow list: if true;

      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.userId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.userId);
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isSignedIn() && isOwner(userId) && resource != null;
    }
  }
}