/**
 * @file Agriassist Firestore Security Rules
 * @description This ruleset enforces a data model where entries are stored in a flat collection (`/entries/{entryId}`).
 *
 * Data Structure:
 * All entries are stored under the `/entries/{entryId}` path. Each entry document contains all the data required
 * to make authorization decisions, including the `userId` of the user who created the entry.
 *
 * Key Security Decisions:
 * - Public Read: All entries are publicly readable.
 * - Owner-Only Writes: Only the user who created the entry can modify or delete it.
 * - Unauthenticated Users: Anonymous users can create entries (userId is set to "").
 *
 * Denormalization for Authorization:
 * The `userId` field is stored directly on each entry document to avoid costly `get()` calls
 * to a separate `/users/{userId}` collection during authorization checks. This allows for simple,
 * performant rules that directly verify ownership.
 *
 * Structural Segregation:
 * The app uses a single `entries` collection to store all entries, regardless of the user's authentication status.
 * This approach simplifies the data model and eliminates the need for separate collections for authenticated and
 * anonymous users.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants public read access to all entries and restricts write access to the owner of the entry.
     * @path /entries/{entryId}
     * @allow (get, list): Any user can read any entry.
     * @allow (create): Any user can create an entry if the `userId` matches their auth UID or is an empty string.
     * @allow (update, delete): Only the owner of the entry can update or delete it, and only if the document exists.
     * @deny (create): A user cannot create an entry with a `userId` that does not match their auth UID when authenticated.
     * @deny (update, delete): A non-owner cannot update or delete an entry.
     * @principle Public Read with Owner-Only Writes, Enforces document ownership for writes.
     */
    match /entries/{entryId} {
      // Allow anyone to read all entries
      allow get, list: if true;

      // Allow the user to create a new entry if the userId matches their auth.uid or if the user is not signed in (anonymous)
      allow create: if isSignedIn() ? request.resource.data.userId == request.auth.uid : request.resource.data.userId == "";

      // Allow the owner to update an existing entry. Enforce immutability on userId
      allow update: if isExistingOwner(resource.data.userId) && (resource.data.userId == resource.data.userId);

      // Allow the owner to delete an existing entry
      allow delete: if isExistingOwner(resource.data.userId);

      function isSignedIn() {
        return request.auth != null;
      }

      // Check if the user is the owner of the entry and the document exists
      function isExistingOwner(userId) {
        return isSignedIn() && isOwner(userId) && resource != null;
      }

      // Helper function to determine if the current user is the owner
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
    }
  }
}