/**
 * @fileoverview Firestore Security Rules for Agriassist.
 *
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for submitted crop data entries,
 * with anonymous users allowed, but their entries tied to their anonymous UID.
 *
 * Data Structure:
 * All crop data entries are stored in the top-level /crop_data/{entryId} collection.
 * Each entry contains a 'userId' field indicating the owner (which can be the anonymous auth UID).
 *
 * Key Security Decisions:
 * - Users can only create, update, or delete entries they own.
 * - Listing crop data is public.
 * - Data validation is relaxed in this prototyping phase.
 *
 * Denormalization for Authorization:
 * The 'userId' field is denormalized directly onto the /crop_data/{entryId} documents to
 * avoid needing to query a separate /users collection for ownership checks. This allows for
 * simple and performant isOwner() checks within the rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to individual crop data entries.
     * @path /crop_data/{entryId}
     * @allow (create) User with auth UID 'user_abc' creates a new entry with userId 'user_abc'.
     * @allow (update) User with auth UID 'user_abc' updates an existing entry where userId is 'user_abc'.
     * @allow (delete) User with auth UID 'user_abc' deletes an existing entry where userId is 'user_abc'.
     * @allow (get, list) Anyone can read crop data entries.
     * @deny (create) User with auth UID 'user_xyz' attempts to create a new entry with userId 'user_abc'.
     * @deny (update) User with auth UID 'user_xyz' attempts to update an existing entry where userId is 'user_abc'.
     * @deny (delete) User with auth UID 'user_xyz' attempts to delete an existing entry where userId is 'user_abc'.
     * @principle Enforces document ownership for writes, allows public reads.
     */
    match /crop_data/{entryId} {
      // Allow anyone to read crop data entries.
      allow get, list: if true;

      // Only allow the owner to create, update, or delete entries.
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && isExistingOwner(resource.data.userId);
      allow delete: if isSignedIn() && isExistingOwner(resource.data.userId);
    }

    // ----- Helper functions -----

    // Checks if the user is signed in.
    function isSignedIn() {
      return request.auth != null;
    }

    // Checks if the user is the owner of the document.
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Checks if the user is the owner of the existing document.
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
  }
}