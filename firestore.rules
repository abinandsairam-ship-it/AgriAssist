rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures the `entries` collection, allowing public reads and owner-only writes.
     * @path /entries/{entryId}
     * @allow (get, list) if true;
     * @allow (create) if isSignedIn() && request.auth.uid == request.resource.data.userId; Example: User "user123" creates a new entry with userId "user123".
     * @allow (update, delete) if isSignedIn() && isExistingOwner(); Example: User "user123" updates an existing entry they own.
     * @deny (create) if request.auth.uid != request.resource.data.userId; Example: User "user123" attempts to create an entry with userId "user456".
     * @deny (update, delete) if !isSignedIn(); Example: Anonymous user tries to update or delete any entry.
     * @deny (update, delete) if !isExistingOwner(resource.data.userId); Example: User "user123" tries to update or delete an entry owned by "user456".
     * @principle Allows public reads, but restricts writes to authenticated owners of the documents.
     */
    match /entries/{entryId} {
      allow get, list: if true;

      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;
      allow update, delete: if isSignedIn() && isExistingOwner();

       //Explicitly deny all other operations
      //allow read: if true; //Redundant with get, list
      //allow write: if false; //Covered by more specific rules
    }


    // --- Helper functions ---

    /**
     * @description Checks if the user is signed in.
     * @return {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the document.
     * @param {string} userId The user ID to compare against the request's auth UID.
     * @return {bool} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner of the document and the document exists.
     * @param {string} userId The user ID to compare against the resource's userId field.
     * @return {bool} True if the user is the owner and the document exists, false otherwise.
     */
    function isExistingOwner() {
      return isSignedIn() && resource.data.userId == request.auth.uid;
    }
  }
}